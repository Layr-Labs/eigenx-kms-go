name: Release Production

on:
  create:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

env:
  GO_VERSION: "1.24"

jobs:
  release:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.2.2
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Ensure tag is on default branch
        run: |
          TAG="${{ github.ref_name }}"
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          git fetch origin "$DEFAULT_BRANCH"
          TAG_COMMIT=$(git rev-parse "$TAG")
          if ! git merge-base --is-ancestor "$TAG_COMMIT" "origin/$DEFAULT_BRANCH"; then
            echo "ERROR: Tag $TAG points to a commit not on $DEFAULT_BRANCH"
            echo "Tag commit: $TAG_COMMIT"
            exit 1
          fi

      - name: Verify tag format
        run: |
          TAG="${{ github.ref_name }}"
          if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+ ]]; then
            echo "Tag '$TAG' does not match required pattern v<major>.<minor>.<patch>"
            exit 1
          fi
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "Validated tag: $TAG"

      - name: Verify VERSION file matches tag
        run: |
          VERSION_FILE=$(cat VERSION | tr -d '[:space:]')
          TAG="${{ env.TAG }}"
          if [[ "$VERSION_FILE" != "$TAG" ]]; then
            echo "ERROR: VERSION file ($VERSION_FILE) does not match tag ($TAG)"
            exit 1
          fi
          echo "VERSION=$VERSION_FILE" >> $GITHUB_ENV

      - name: Get commit SHA
        run: |
          COMMIT_SHA=$(git rev-parse HEAD)
          SHORT_SHA=${COMMIT_SHA:0:7}
          echo "COMMIT_SHA=$COMMIT_SHA" >> $GITHUB_ENV
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
          echo "Release tag points to commit: $COMMIT_SHA"

      - name: Set up Go
        uses: actions/setup-go@19bb51245e9c80abacb2e91cc42b33fa478b8639 # v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@8b0419c685ef46cb79ec93fbdc131174afceb730 # v1
        with:
          version: v1.2.3

      - name: Install dependencies
        run: |
          make deps
          export PATH=$PATH:$(go env GOPATH)/bin

      - name: Run tests
        services:
          redis:
            image: redis:7-alpine
            options: >-
              --health-cmd "redis-cli ping"
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
            ports:
              - 6379:6379
        run: |
          make test

      - name: Build binaries
        run: |
          VERSION="${{ env.VERSION }}"
          echo "Building binaries for version $VERSION"
          make build/cmd
          sudo chown -R $USER:$USER .

      - name: Bundle release artifacts
        run: |
          VERSION="${{ env.VERSION }}"
          ./scripts/bundleReleases.sh $VERSION

      - name: Build and push container image
        uses: ./.github/workflows/build-container.yaml
        with:
          registry: "public.ecr.aws/j0c8z4y5"
        secrets:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}

      - name: Build and push client container
        uses: ./.github/workflows/build-client-container.yaml
        with:
          dockerfile: 'kmsClient/Dockerfile'
          platforms: 'linux/amd64,linux/arm64'
        permissions:
          contents: read
          packages: write

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          prerelease: false
          files: ./release/*.tar*
          generate_release_notes: true
          tag: ${{ env.TAG }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release summary
        run: |
          echo "Production release created successfully!"
          echo "Version: ${{ env.VERSION }}"
          echo "Tag: ${{ env.TAG }}"
          echo "Commit: ${{ env.SHORT_SHA }}"
          echo "Container: public.ecr.aws/j0c8z4y5/eigenx-kms:${{ env.VERSION }}"
          echo "View release: https://github.com/${{ github.repository }}/releases/tag/${{ env.TAG }}"
